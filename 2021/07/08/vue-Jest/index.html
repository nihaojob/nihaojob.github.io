<!DOCTYPE html>
<html lang="en">

<head>

  <!-- Minima -->
  <!-- Hexo theme created by @adisaktijrs -->

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">

  
  <title>Vue业务系统落地单元测试</title>
  
  <link rel="canonical" href="https://nihaojob.github.io/2021/07/08/vue-Jest/">
  
  <meta name="description" content="一直对单测很感兴趣，但对单测覆盖率、测试报告等关键词懵懵懂懂，最近几个月一直在摸索如何在Vue业务系统中落地单元测试，看到慢慢增长的覆盖率，慢慢清晰的模块，对单元测试的理解也比以前更加深入，也有一些心得和收获。 今天把自己的笔记分享出来，和大家一起交流我在2个较为复杂的Vue业务系统中落地单测的一些">
  
  
  <meta name="author" content="nihaojob@163.com">
  
  <meta property="og:image" content="https://nihaojob.github.ioundefined">
  
  <meta property="og:site_name" content="秦少卫的博客" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Vue业务系统落地单元测试" />
  
  <meta property="og:description" content="一直对单测很感兴趣，但对单测覆盖率、测试报告等关键词懵懵懂懂，最近几个月一直在摸索如何在Vue业务系统中落地单元测试，看到慢慢增长的覆盖率，慢慢清晰的模块，对单元测试的理解也比以前更加深入，也有一些心得和收获。 今天把自己的笔记分享出来，和大家一起交流我在2个较为复杂的Vue业务系统中落地单测的一些">
  
  <meta property="og:url" content="https://nihaojob.github.io/2021/07/08/vue-Jest/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Vue业务系统落地单元测试">
  
  <meta name="twitter:description" content="一直对单测很感兴趣，但对单测覆盖率、测试报告等关键词懵懵懂懂，最近几个月一直在摸索如何在Vue业务系统中落地单元测试，看到慢慢增长的覆盖率，慢慢清晰的模块，对单元测试的理解也比以前更加深入，也有一些心得和收获。 今天把自己的笔记分享出来，和大家一起交流我在2个较为复杂的Vue业务系统中落地单测的一些">
  
  
  <meta name="twitter:image" content="https://nihaojob.github.ioundefined">
  
  <meta name="twitter:url" content="https://nihaojob.github.io/2021/07/08/vue-Jest/" />

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Preload fonts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="preload" href="../fonts/dm-serif-display-v4-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="../fonts/inter-v2-latin-regular.woff2" as="font" type="font/woff2" crossorigin>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<link rel="stylesheet" href="/css/normalize.css">

  
<link rel="stylesheet" href="/css/skeleton.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
<link rel="stylesheet" href="/css/prism-dark.css">

  
<link rel="stylesheet" href="/css/prism-line-numbers.css">

  <!-- User css -->
  
  
<link rel="stylesheet" href="/css/user.css">

  

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

  <!-- Custom Theme Color Style
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <style>
  a:not(.icon) {
    text-decoration-color: #0FA0CE;
    background-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0) 50%,
      #0FA0CE 50%
    );
  }
  blockquote {
    border-left: 8px solid #0FA0CE;
  }
  .nanobar .bar {
    background: #0FA0CE;
  }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    background-color: #0FA0CE;
    border-color: #0FA0CE;
  }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #0FA0CE;
  }
</style>

  <!-- Google Analytics (With Privacy Settings On)
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="秦少卫的博客" type="application/atom+xml">
</head>

<body>
  <div class="container">
    <div class="row">
      <div>

        <div class="row">
  <div class="two columns" style="max-width: 50px">
    <h1 class="mt-2 mode">
      <div onclick=setDarkMode(true) id="darkBtn">🌑</div>
      <div onclick=setDarkMode(false) id="lightBtn" class=hidden>☀️</div>
      <script >
        if (localStorage.getItem('preferredTheme') == 'dark') {
          setDarkMode(true)
        }
        function setDarkMode(isDark) {
          var darkBtn = document.getElementById('darkBtn')
          var lightBtn = document.getElementById('lightBtn')
          if (isDark) {
            lightBtn.style.display = "block"
            darkBtn.style.display = "none"
            localStorage.setItem('preferredTheme', 'dark');
          } else {
            lightBtn.style.display = "none"
            darkBtn.style.display = "block"
            localStorage.removeItem('preferredTheme');
          }
          document.body.classList.toggle("darkmode");
        }
      </script>
    </h1>
  </div>

  <div class="six columns ml-1">
    <h1 class="mt-2">
      秦少卫的博客
    </h1>
  </div>

  <div class="twelve columns">
    <div class="row">
      <div class="nine columns left">
        <a href="/">主页</a>
        
          
          <a href="/archives" class="ml">归档</a>
          
        
          
          <a href="/About" class="ml">关于</a>
          
        
          
          <a href="/atom.xml" class="ml">RSS</a>
          
        
          
          <a target="_blank" rel="noopener" href="https://juejin.cn/user/3843548383549214" class="ml">掘金</a>
          
        
        
      </div>
    </div>
    <hr style="margin-bottom: 2.6rem">
  </div>
</div>

        <div class="trans">
            <h2>Vue业务系统落地单元测试</h2>

  <p>一直对单测很感兴趣，但对单测覆盖率、测试报告等关键词懵懵懂懂，最近几个月一直在摸索如何在Vue业务系统中落地单元测试，看到慢慢增长的覆盖率，慢慢清晰的模块，对单元测试的理解也比以前更加深入，也有一些心得和收获。</p>
<p>今天把自己的笔记分享出来，和大家一起交流我在2个较为复杂的Vue业务系统中落地单测的一些思路和方法，算是入门实践类的笔记，资深大佬还请跳过。</p>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ol>
<li>定义</li>
<li><strong>安装与使用</strong></li>
<li><strong>常用API</strong></li>
<li><strong>落地单元测试</strong></li>
<li><strong>演进：构建可测试的单元模块</strong></li>
<li><strong>可维护的单元模块</strong></li>
<li>回顾</li>
<li>讨论 &amp;&amp; Thank</li>
</ol>
<h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p><strong>单元测试定义：</strong></p>
<p>单元测试是指对软件中的<strong>最小可测试单元进行检查和验证</strong>。单元在质量保证中是非常重要的环节，根据测试金字塔原理，越往上层的测试，所需的测试投入比例越大，效果也越差，而单元测试的成本要小的多，也更容易发现问题。</p>
<p>也有不同的测试分层策略（冰淇淋模型、冠军模型）。</p>
<p><strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c916b65f711945a19d6f61ecdc386882~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></strong></p>
<h2 id="2-安装与使用"><a href="#2-安装与使用" class="headerlink" title="2. 安装与使用"></a>2. 安装与使用</h2><h4 id="1-vue项目添加-vue-unit-jest-文档"><a href="#1-vue项目添加-vue-unit-jest-文档" class="headerlink" title="1. vue项目添加 @vue/unit-jest 文档"></a>1. vue项目添加 @vue/unit-jest <a target="_blank" rel="noopener" href="https://vue-test-utils.vuejs.org/zh/guides/#%E5%AE%89%E8%A3%85">文档</a></h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vue <span class="token function">add</span> @vue/unit-jest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>安装完成后，在package.json中会多出test:unit脚本选项，并生成jest.config.js文件。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"avatar"</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"test:unit"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service test:unit"</span><span class="token punctuation">,</span> <span class="token comment">// 新增的脚本</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>生成测试报告的脚本：增加–coverage自定义参数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"avatar"</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"test:unit"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service test:unit"</span><span class="token punctuation">,</span>
    <span class="token string">"test:unitc"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service test:unit  --coverage"</span><span class="token punctuation">,</span> <span class="token comment">// 测试并生成测试报告</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-VScode-vscode-jest-runner-插件配置"><a href="#2-VScode-vscode-jest-runner-插件配置" class="headerlink" title="2. VScode vscode-jest-runner 插件配置"></a>2. VScode vscode-jest-runner 插件配置</h4><p>作用：VS Code打开测试文件后，可直接运行用例。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4df9e177d49140d3833c73235b1ff00a~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>运行效果：<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2617ab4e4ba24c6c825ae557e0ef8284~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>不通过效果：<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7adf5ee537f342948bf8e1429b8ccf5e~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p>安装插件：<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=firsttris.vscode-jest-runner">https://marketplace.visualstudio.com/items?itemName=firsttris.vscode-jest-runner</a><br>配置项：设置 =&gt; jest-Runner Config</p>
<ul>
<li>Code Lens Selector：匹配的文件，**/*.{test,spec}.{js,jsx,ts,tsx}</li>
<li>Jest Command：定义Jest命令，默认为Jest 全局命令。</li>
</ul>
<p>将Jest Command替换为 test:unit，使用vue脚手架提供的 test:unit 进行单元测试。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/326c34d8ec3a45e09ed532267c395892~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h4 id="3-githook-配置"><a href="#3-githook-配置" class="headerlink" title="3. githook 配置"></a>3. githook 配置</h4><p>作用：在提交时执行所有测试用例，有测试用例不通过或覆盖率不达标时取消提交。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/571482fd44e6457694730be6fe93ccb6~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8063d92f2b9244cf9e57306460369803~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p>安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> husky --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配置：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"avatar"</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"test:unit"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service test:unit"</span><span class="token punctuation">,</span>
    <span class="token string">"test:unitc"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service test:unit  --coverage"</span><span class="token punctuation">,</span> <span class="token comment">// 测试并生成测试报告</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"husky"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"hooks"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"npm run test:unitc"</span> <span class="token comment">// commit时执行参单元测试 并生成测试报告</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置牵引指标：jest.config.js，可全局设置、对文件夹设置、对单个文件设置。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  preset<span class="token operator">:</span> <span class="token string">'@vue/cli-plugin-unit-jest'</span><span class="token punctuation">,</span>
  timers<span class="token operator">:</span> <span class="token string">'fake'</span><span class="token punctuation">,</span>
  coverageThreshold<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
   global<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 全局</span>
      branches<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      functions<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      lines<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      statements<span class="token operator">:</span> <span class="token number">10</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">'./src/common/**/*.js'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 文件夹</span>
      branches<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      statements<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">'./src/common/agoraClientUtils.js'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 单个文件</span>
      branches<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
      functions<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
      lines<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
      statements<span class="token operator">:</span> <span class="token number">80</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="4-测试报告"><a href="#4-测试报告" class="headerlink" title="4. 测试报告"></a>4. 测试报告</h4><p>生成的测试报告在跟目录下的<code>coverage</code>文件夹下，主要是4个指标。</p>
<blockquote>
<ul>
<li>语句覆盖率（statement coverage）每个语句是否都执行</li>
<li>分支覆盖率（branch coverage）每个if代码块是否都执行</li>
<li>函数覆盖率（function coverage）每个函数是否都调用</li>
<li>行覆盖率（line coverage) 每一行是否都执行了</li>
</ul>
</blockquote>
<p>根目录截图<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad0e6c648ab14d048149a6eb149e606b~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>文件夹目录截图：三种颜色代表三种状态：红色、黄色、绿色。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d4d1d67eec04889820a6a0736debe3e~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>单个文件截图：红色行为未覆盖，绿色行为运行次数。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a4abfd2c214484e8ee7dcd24b64dcd5~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h2 id="3-常用API"><a href="#3-常用API" class="headerlink" title="3. 常用API"></a>3. 常用API</h2><p>抛砖引玉，只展示简单的用法，具体可参见文档。</p>
<p><strong>Jest常用方法：</strong><br><a target="_blank" rel="noopener" href="https://jestjs.io/zh-Hans/">文档</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 例子</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'versionToNum 版本号转数字'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'10.2.3 => 10.2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">versionToNum</span><span class="token punctuation">(</span><span class="token string">'10.2.3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10.2</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'11.2.3 => 11.2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">versionToNum</span><span class="token punctuation">(</span><span class="token string">'11.2.3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">11.2</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/*------------------------------------------------*/</span>

<span class="token comment">// 值对比</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">expect</span><span class="token punctuation">(</span>operationServe<span class="token punctuation">.</span>operationPower<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 对象对比</span>
<span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>one<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> two<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// JSON 对比</span>
<span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span>afterJson<span class="token punctuation">)</span>


<span class="token comment">// 每次执行前</span>
<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// do  some thing....</span>
  <span class="token comment">// DOM 设置</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div id="pc" class="live-umcamera-video" style="position: relative;">
        &lt;div style="width:200px; height:300px; position:absolute; top:20px; left:500px;">
            &lt;video style="width:300px; height:400px;"
                autoplay="" muted="" playsinline="">&lt;/video>
        &lt;/div>
    &lt;/div></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// Mock</span>
<span class="token keyword">const</span> getCondition <span class="token operator">=</span>  jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameterName<span class="token operator">:</span> <span class="token string">'hulala'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Promise 方法</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取预置埋点 - pages'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'pages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// logType不包含presetEvent、不等于 pages，获取预置埋点</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>findPresetList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 定时器方法  </span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'定时器 新建 执行'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntervalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  timer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'oneset'</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  jest<span class="token punctuation">.</span><span class="token function">runTimersToTime</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">// 等待2秒</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><strong>@vue/test-utils常用方法：</strong><br><a target="_blank" rel="noopener" href="https://vue-test-utils.vuejs.org/zh/">文档</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 例子</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> mount <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'./counter'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 现在挂载组件，你便得到了这个包裹器</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders the correct markup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'&lt;span class="count">0&lt;/span>'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  <span class="token comment">// 也便于检查已存在的元素</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'has a button'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/*------------------------------------------------*/</span>


<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> shallowMount<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> render<span class="token punctuation">,</span> renderToString<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">'../HelloWorld.vue'</span>

<span class="token comment">// router模拟</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> localVue <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 伪造</span>
<span class="token keyword">const</span> $route <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  path<span class="token operator">:</span> <span class="token string">'/some/path'</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  mocks<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    $route
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token comment">// store 模拟</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      state<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      actions
 <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> localVue<span class="token punctuation">,</span> store <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'错误信息展示'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// shallowMount  入参模拟</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>cloudPhone<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      propsData<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        mosaicStatus<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        customerOnLine<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        cloudPhoneState<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        cloudPhoneError<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        cloudPhoneTip<span class="token operator">:</span> <span class="token string">'发生错误'</span><span class="token punctuation">,</span>
        delay<span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    
    
    <span class="token comment">// 子组件是否展示</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>Tip<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// html判断</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'发生错误'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// DOM 元素判断</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'.mosaicStatus'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isVisible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
   	<span class="token comment">// 执行点击事件</span>
    <span class="token keyword">await</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  	<span class="token comment">// class</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">classes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">classes</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token comment">// 子组件查找  	</span>
  	wrapper<span class="token punctuation">.</span><span class="token function">findComponent</span><span class="token punctuation">(</span>Bar<span class="token punctuation">)</span>
    <span class="token comment">// 销毁</span>
   	wrapper<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// </span>
   	wrapper<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> foo<span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  	
  	<span class="token comment">// axios模拟</span>
   	jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      get<span class="token operator">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="4-落地单元测试"><a href="#4-落地单元测试" class="headerlink" title="4. 落地单元测试"></a>4. 落地单元测试</h2><p>❌ 直接对一个较大的业务组件添加单元测试，需要模拟一系列的全局函数，无法直接运行。</p>
<p><strong>问题：</strong></p>
<ol>
<li>逻辑多：业务逻辑不清楚，1000+ 行</li>
<li>依赖多：<code>$dayjs、$api、$validate、$route、$echarts、mixins、$store</code>…</li>
<li>路径不一致：有<code>@</code>、<code>./</code>、<code>../</code></li>
</ol>
<blockquote>
<p>单元测试是用来对一个模块、一个函数或者一个类来进行正确性检验的测试工作。<br>– 廖雪峰的官方网站</p>
</blockquote>
<p><strong>落地：</strong></p>
<p>✅ 对业务逻辑关键点，<strong>抽出纯函数、类方法、组件，并单独增加测试代码</strong>。</p>
<p><strong>例子：</strong><br>获取分组参数，由7个接口聚合。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59831dcee1794629955d3d5a0ad2618f~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b06a2326738f40d1ab942eb6540e84d4~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2b45f82ac9d542788aa3b2126d1252d8~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>原有逻辑：<br>系统参数存全局变量，自定义参数存全局变量</p>
<ul>
<li>无法看出多少种类型与接口数量</li>
<li>无法在多个位置直接复用<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">getCondition</span> <span class="token punctuation">(</span><span class="token parameter">fIndex<span class="token punctuation">,</span> oneFunnel</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 添加限制条件，如果该事件没有先拉取</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>biz<span class="token punctuation">,</span> logType<span class="token punctuation">,</span> event<span class="token punctuation">,</span> feCreateType<span class="token punctuation">&#125;</span> <span class="token operator">=</span> oneFunnel
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 私有限制条件为空，且不是预置事件 或 页面组，就拉取私有限制条件</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>extraParamsList<span class="token punctuation">.</span>parameterList<span class="token punctuation">,</span> fIndex<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>logType <span class="token operator">!==</span> <span class="token string">'pages'</span> <span class="token operator">&amp;&amp;</span> logType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'presetEvent'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>logType<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">ParameterList</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
              biz<span class="token operator">:</span> logType <span class="token operator">===</span> <span class="token string">'server'</span> <span class="token operator">&amp;&amp;</span> feCreateType <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> biz<span class="token punctuation">,</span>
              event<span class="token operator">:</span> event<span class="token punctuation">,</span>
              terminal<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customType<span class="token punctuation">[</span>logType<span class="token punctuation">]</span><span class="token punctuation">,</span>
              platform<span class="token operator">:</span> logType <span class="token operator">===</span> <span class="token string">'server'</span> <span class="token operator">&amp;&amp;</span> feCreateType <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'common'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
              pageNum<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>ret <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                res<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>extraParamsList<span class="token punctuation">.</span>parameterList<span class="token punctuation">[</span>fIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span>parameterName <span class="token operator">||</span> element<span class="token punctuation">.</span>parameter_name<span class="token punctuation">,</span> element<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'获取事件属性失败，请联系后台管理员'</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>logType <span class="token operator">===</span> <span class="token string">'presetEvents'</span> <span class="token operator">||</span>  logType <span class="token operator">===</span> <span class="token string">'presetEventsApp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span><span class="token function">findPresetList</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
              biz<span class="token punctuation">,</span>
              appTerminal<span class="token operator">:</span> logType<span class="token punctuation">,</span>
              operation<span class="token operator">:</span> event
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                  item<span class="token punctuation">.</span>description <span class="token operator">=</span> item<span class="token punctuation">.</span>name
                  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>extraParamsList<span class="token punctuation">.</span>parameterList<span class="token punctuation">[</span>fIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'无需拉取'</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      
     <span class="token function">getGlobalCondition</span> <span class="token punctuation">(</span><span class="token parameter">funnelId</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 获取 全局 基础选项</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span><span class="token function">getGlobalCondition</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          funnelId<span class="token operator">:</span> funnelId<span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conditionMode
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>bizList<span class="token punctuation">,</span> expressions<span class="token punctuation">,</span> expressionsNumber<span class="token punctuation">,</span> comBizList<span class="token punctuation">&#125;</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data
            <span class="token keyword">this</span><span class="token punctuation">.</span>bizList <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token operator">...</span>bizList<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>comBizList <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token operator">...</span>comBizList<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>comBizKeyList <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>comBizList<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>operatorList <span class="token operator">=</span> expressions
            <span class="token keyword">this</span><span class="token punctuation">.</span>numberOperatorList <span class="token operator">=</span> expressionsNumber
            <span class="token keyword">this</span><span class="token punctuation">.</span>comBizKey <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>comBizList<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getComBizEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'获取基础选项失败，请联系后台管理员'</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'获取基础选项失败，请联系后台管理员'</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  
      
   <span class="token function">setCommonPropertiesList</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 初始化 公共限制条件列表 commonPropertiesList</span>
      <span class="token keyword">const</span> commonPropertiesList <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        auto<span class="token operator">:</span> data<span class="token punctuation">.</span>h5AutoCommonProperties<span class="token punctuation">,</span>
        pages<span class="token operator">:</span> data<span class="token punctuation">.</span>h5PagesCommonProperties<span class="token punctuation">,</span>
        presetEvents<span class="token operator">:</span> data<span class="token punctuation">.</span>h5PresetCommonProperties<span class="token punctuation">,</span> <span class="token comment">// h5 预置事件 公共属性</span>
        customH5<span class="token operator">:</span> data<span class="token punctuation">.</span>h5CustomCommonProperties<span class="token punctuation">,</span>
        customApp<span class="token operator">:</span> data<span class="token punctuation">.</span>appCustomCommonProperties<span class="token punctuation">,</span>
        presetEventsApp<span class="token operator">:</span> data<span class="token punctuation">.</span>appPresetCommonProperties<span class="token punctuation">,</span> <span class="token comment">// App 预置事件 公共属性</span>
        server<span class="token operator">:</span> data<span class="token punctuation">.</span>serverCommonProperties<span class="token punctuation">,</span>
        customWeapp<span class="token operator">:</span> data<span class="token punctuation">.</span>weappCustomCommonProperties<span class="token punctuation">,</span>
        presetEventsWeapp<span class="token operator">:</span> data<span class="token punctuation">.</span>weappPresetCommonProperties<span class="token punctuation">,</span> <span class="token comment">// Weapp 预置事件 公共属性</span>
        presetEventsServer<span class="token operator">:</span> data<span class="token punctuation">.</span>serverPresetCommonProperties <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Server 预置事件 公共属性</span>
        presetEventsAd<span class="token operator">:</span> data<span class="token punctuation">.</span>adPresetCommonProperties
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> type <span class="token keyword">in</span> commonPropertiesList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将parameter_name的值作为key，item作为value，组合为k-v形式</span>
        <span class="token keyword">let</span> properties <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>commonPropertiesList<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>
        commonPropertiesList<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          properties<span class="token punctuation">[</span>item<span class="token punctuation">.</span>parameter_name<span class="token punctuation">]</span> <span class="token operator">=</span> item
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        commonPropertiesList<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> properties
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>commonPropertiesList <span class="token operator">=</span> commonPropertiesList
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
拆分模块后：<br>建立GetParamsServer主类，该类由2个子类构成，并聚合子类接口。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/754d1c384cf841c69b5a558c87341f6a~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></li>
</ul>
<p>这是其中一个子类，获取私有参数的单元测试：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> GetParamsServer<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> GetPrivateParamsServer <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@/views/analysis/components/getParamsServer.js'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GetPrivateParamsServer 私有参数获取'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> $api
    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      $api <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        analysis<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          findPresetList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            code<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">'hulala'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">'234234'</span><span class="token punctuation">,</span> data_type<span class="token operator">:</span> <span class="token string">'event'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 预置埋点</span>
          serverParameterList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameterName<span class="token operator">:</span> <span class="token string">'hulala'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 服务端埋点</span>
          autoParameterList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameter_name<span class="token operator">:</span> <span class="token string">'hulala'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// H5全埋点</span>
          customH5ParameterList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameterName<span class="token operator">:</span> <span class="token string">'hulala'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// H5自定义</span>
          customWeappParameterList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameter_name<span class="token operator">:</span> <span class="token string">'hulala'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">'234234'</span><span class="token punctuation">,</span> data_type<span class="token operator">:</span> <span class="token string">'event'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Weapp自定义</span>
          customAppParameterList<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            ret<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> parameterName<span class="token operator">:</span> <span class="token string">'hulala'</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">'asdfafd'</span><span class="token punctuation">,</span> data_type<span class="token operator">:</span> <span class="token string">'event'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// App自定义</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GetPrivateParamsServer 不同类型获取'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取预置埋点 - pages'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'pages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// logType不包含presetEvent、不等于 pages，获取预置埋点</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>findPresetList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取预置埋点 - presetEvent '</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'presetEvent'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// logType不包含presetEvent、不等于 pages，获取预置埋点</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>findPresetList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - 其他'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'12312'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>findPresetList<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'server'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>serverParameterList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - auto'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'auto'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>autoParameterList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - customH5'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'customH5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>customH5ParameterList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - customWeapp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'customWeapp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>customWeappParameterList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - customApp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'customApp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>$api<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>customAppParameterList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - 不存在类型'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'哈哈哈哈'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GetPrivateParamsServer 结果转换为label'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取预置埋点 - pages'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getConditionLabel</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'pages'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>types<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dataType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - customWeapp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getConditionLabel</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'customWeapp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>types<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dataType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'获取非预置埋点 - customApp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> paramsServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetPrivateParamsServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      paramsServer<span class="token punctuation">.</span><span class="token function">initApi</span><span class="token punctuation">(</span>$api<span class="token punctuation">)</span>
      <span class="token keyword">return</span> paramsServer<span class="token punctuation">.</span><span class="token function">getConditionLabel</span><span class="token punctuation">(</span><span class="token string">'hz'</span><span class="token punctuation">,</span> <span class="token string">'customApp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>types<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dataType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/415670ec89c54c75b61c2f1b1200ef84~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p><strong>从测试用例看到的代码逻辑：</strong></p>
<ul>
<li>6个接口</li>
<li>6种事件类型</li>
<li>类型与接口的对应关系</li>
<li>接口格式有三种</li>
</ul>
<p><strong>作用：</strong></p>
<ol>
<li>复用：将复杂的业务逻辑封闭在黑盒里，更方便复用。</li>
<li>质量：模块的功能通过测试用例得到保障。</li>
<li>维护：测试即文档，方便了解业务逻辑。</li>
</ol>
<p>实践：在添加单测的过程中，抽象模块，重构部分功能，并对单一职责的模块增加单测。</p>
<h2 id="5-演进：构建可测试单元模块"><a href="#5-演进：构建可测试单元模块" class="headerlink" title="5. 演进：构建可测试单元模块"></a>5. 演进：构建可测试单元模块</h2><p>将业务代码代码演变为可测试代码，重点在：</p>
<ol>
<li>设计：将业务逻辑<strong>拆分为单元模块</strong>（UI组件、功能模块）。</li>
<li>时间：可行的重构目标与重构方法，要有<strong>长期重构</strong>的心理预期。</li>
</ol>
<p><strong>为单一职责的模块设计测试用例，才会对功能覆盖的更全面，所以设计这一步尤为重要。</strong></p>
<blockquote>
<p>如果挽救一个系统的办法是重新设计一个新的系统，那么，<strong>我们有什么理由认为从头开始，结果会更好呢</strong>?<br>–《架构整洁之道》</p>
</blockquote>
<p>原来模块也是有设计，我们如何保证重构后真的比之前更好吗？还是要根据设计原则客观的来判断。</p>
<p><strong>设计原则 SOLID：</strong></p>
<ul>
<li>SRP-单一职责</li>
<li>OCP-开闭：易与扩展，抗拒修改。</li>
<li>LSP-里氏替换：子类接口统一，可相互替换。</li>
<li>ISP-接口隔离：不依赖不需要的东西。</li>
<li>DIP-依赖反转：构建稳定的抽象层，单向依赖（例：A =&gt; B =&gt; C， 反例：A  =&gt; B =&gt; C =&gt; A）。</li>
</ul>
<p>在应接不暇的需求面前，还要拆模块、重构、加单测，无疑是增加工作量，显得不切实际，《重构》这本书给了我很多指导。</p>
<p><strong>重构方法：</strong></p>
<ul>
<li>预备性重构</li>
<li>帮助理解的重构</li>
<li>捡垃圾式重构（营地法则：遇到一个重构一个，像见垃圾一样，让你离开时的代码比来时更干净、健康）</li>
<li>有计划的重构与见机行事的重构</li>
<li>长期重构</li>
</ul>
<p><strong>业务系统1的模块与UI梳理：</strong></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d341a479c8349418e1be072284936e2~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p><strong>业务系统2的模块与UI梳理：</strong></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af1688492c8449aabf15f1797b0569f6~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h2 id="6-可维护的单元模块"><a href="#6-可维护的单元模块" class="headerlink" title="6. 可维护的单元模块"></a>6. 可维护的单元模块</h2><blockquote>
<p>避免重构后再次写出坏味道的代码，提取执行成本更低的规范。</p>
</blockquote>
<p><strong>代码坏味道：</strong></p>
<ul>
<li><strong>神秘命名-无法取出好名字，背后可能潜藏着更深的设计问题。</strong></li>
<li>重复代码</li>
<li><strong>过长函数-小函数、纯函数</strong>。</li>
<li>过长参数</li>
<li><strong>全局数据-数量越多处理难度会指数上升。</strong></li>
<li>可变数据-不知道在哪个节点修改了数据。</li>
<li>发散式变化-只关注当前修改，不用关注其他关联。</li>
<li><strong>霰弹式修改-修改代码散布四处</strong>。</li>
<li>依恋情结-与外部模块交流数据胜过内部数据。</li>
<li><strong>数据泥团-相同的参数在多个函数间传递。</strong></li>
<li>基本类型偏执</li>
<li>重复的switch</li>
<li>循环语句</li>
<li>冗赘的元素</li>
<li>夸夸其谈通用性</li>
<li>临时字段</li>
<li>过长的消息链</li>
<li>中间人</li>
<li>内幕交易</li>
<li><strong>过大的类</strong></li>
<li>异曲同工的类</li>
<li>纯数据类</li>
<li>被拒绝的遗赠-继承父类无用的属性或方法</li>
<li><strong>注释-当你感觉需要撰写注释时，请先尝试重构，试着让所有注释都变得多余。</strong></li>
</ul>
<p><strong>规范：</strong></p>
<ul>
<li>全局变量数量：20 ±</li>
<li>方法方法行数：15 ±</li>
<li>代码行数：300-500</li>
<li>内部方法、内联方法：下划线开头</li>
</ul>
<p><strong>技巧：</strong></p>
<ul>
<li>使用class语法：将紧密关联的方法和变量封装在一起。</li>
<li>使用Eventemitter 工具库：实现简单发布订阅。</li>
<li>使用vue  provide语法：传递实例。</li>
<li>使用koroFileHeader插件： 统一注释规范。</li>
<li>使用Git-commit-plugin插件： 统一commit规范。</li>
<li>使用eslint + stylelint（未使用变量、误改变量名、debugger，自动优化的css）。</li>
</ul>
<p>示例代码：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*
 * @name: 轻量级message提示插件
 * @Description: 模仿iview的$message方法，api与样式保持一致。
 */</span>

<span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">&#123;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls <span class="token operator">=</span> <span class="token string">'i-message-'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_default <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            top<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">info</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_message</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_message</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">warning</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_message</span><span class="token punctuation">(</span><span class="token string">'warning'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_message</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">loading</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_message</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">config</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_default<span class="token punctuation">.</span>top<span class="token punctuation">,</span> duration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_default<span class="token punctuation">.</span>duration <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_default <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            top<span class="token punctuation">,</span>
            duration
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setContentBoxTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> boxId <span class="token operator">=</span> <span class="token string">'messageBox'</span>
        <span class="token keyword">const</span> contentBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> boxId<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentBox<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>contentBox<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 渲染消息
     * @param &#123;String&#125; type 类型
     * @param &#123;Object | String&#125; options 详细格式
     */</span>
    <span class="token function">_message</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                content<span class="token operator">:</span> options
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>content<span class="token punctuation">,</span> options<span class="token punctuation">.</span>duration<span class="token punctuation">,</span> type<span class="token punctuation">,</span> options<span class="token punctuation">.</span>onClose<span class="token punctuation">,</span> options<span class="token punctuation">.</span>closable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 渲染消息
     * @param &#123;String&#125; content 消息内容
     * @param &#123;Number&#125; duration 持续时间
     * @param &#123;String&#125; type 消息类型
     */</span>
    <span class="token function">_render</span><span class="token punctuation">(</span>content <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> duration <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_default<span class="token punctuation">.</span>duration<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onClose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> closable <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取节点信息</span>
        <span class="token keyword">const</span> messageDOM <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getMsgHtml</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> content<span class="token punctuation">,</span> closable<span class="token punctuation">)</span>
        <span class="token comment">// 插入父容器</span>
        <span class="token keyword">const</span> contentBox <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getContentBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>messageDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除方法</span>
        <span class="token keyword">const</span> <span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeMsg</span><span class="token punctuation">(</span>contentBox<span class="token punctuation">,</span> messageDOM<span class="token punctuation">,</span> onClose<span class="token punctuation">)</span>
        <span class="token keyword">let</span> removeTimer
        <span class="token keyword">if</span><span class="token punctuation">(</span>duration <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            removeTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>remove<span class="token punctuation">,</span> duration <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 关闭按钮</span>
        closable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addClosBtn</span><span class="token punctuation">(</span>messageDOM<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> removeTimer<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 删除消息
     * @param &#123;Element&#125; contentBox 父节点
     * @param &#123;Element&#125; messageDOM 消息节点
     * @param &#123;Number&#125; duration 持续时间
     */</span>
    <span class="token function">_removeMsg</span><span class="token punctuation">(</span><span class="token parameter">contentBox<span class="token punctuation">,</span> messageDOM<span class="token punctuation">,</span> onClose</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        messageDOM<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">box animate__animated animate__fadeOutUp</span><span class="token template-punctuation string">`</span></span>
        messageDOM<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            contentBox<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>messageDOM<span class="token punctuation">)</span>
            <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 获取图标
     * @param &#123;String&#125; type
     * @return &#123;String&#125; DOM HTML 字符串
     */</span>
    <span class="token function">_getIcon</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            info<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg style="color:#2db7f5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           &lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         &lt;/svg></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            success<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg style="color:#19be6b"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
           &lt;path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
         &lt;/svg></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            warning<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg style="color:#ff9900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           &lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         &lt;/svg></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg style="color:#ed4014" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
           &lt;path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
         &lt;/svg></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            loading<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg style="color:#2db7f5" xmlns="http://www.w3.org/2000/svg" class="loading" viewBox="0 0 20 20" fill="currentColor">
           &lt;path fill-rule="evenodd" d="M9.504 1.132a1 1 0 01.992 0l1.75 1a1 1 0 11-.992 1.736L10 3.152l-1.254.716a1 1 0 11-.992-1.736l1.75-1zM5.618 4.504a1 1 0 01-.372 1.364L5.016 6l.23.132a1 1 0 11-.992 1.736L4 7.723V8a1 1 0 01-2 0V6a.996.996 0 01.52-.878l1.734-.99a1 1 0 011.364.372zm8.764 0a1 1 0 011.364-.372l1.733.99A1.002 1.002 0 0118 6v2a1 1 0 11-2 0v-.277l-.254.145a1 1 0 11-.992-1.736l.23-.132-.23-.132a1 1 0 01-.372-1.364zm-7 4a1 1 0 011.364-.372L10 8.848l1.254-.716a1 1 0 11.992 1.736L11 10.58V12a1 1 0 11-2 0v-1.42l-1.246-.712a1 1 0 01-.372-1.364zM3 11a1 1 0 011 1v1.42l1.246.712a1 1 0 11-.992 1.736l-1.75-1A1 1 0 012 14v-2a1 1 0 011-1zm14 0a1 1 0 011 1v2a1 1 0 01-.504.868l-1.75 1a1 1 0 11-.992-1.736L16 13.42V12a1 1 0 011-1zm-9.618 5.504a1 1 0 011.364-.372l.254.145V16a1 1 0 112 0v.277l.254-.145a1 1 0 11.992 1.736l-1.735.992a.995.995 0 01-1.022 0l-1.735-.992a1 1 0 01-.372-1.364z" clip-rule="evenodd" />
         &lt;/svg></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 获取消息节点
     * @param &#123;String&#125; type 类型
     * @param &#123;String&#125; content 消息内容
     * @return &#123;Element&#125; 节点DOM对象
     */</span>
    <span class="token function">_getMsgHtml</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> messageDOM <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span>
        messageDOM<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">box animate__animated animate__fadeInDown</span><span class="token template-punctuation string">`</span></span>
        messageDOM<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">36</span> <span class="token operator">+</span> <span class="token string">'px'</span>
        messageDOM<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                &lt;div class="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">message" >
                    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getIcon</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
                    &lt;div class="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">content-text"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/div>
                &lt;/div>
        </span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> messageDOM
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 添加关闭按钮
     * @param &#123;Element&#125; messageDOM 消息节点DOM
     */</span>
    <span class="token function">_addClosBtn</span><span class="token punctuation">(</span><span class="token parameter">messageDOM<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> removeTimer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> svgStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;svg class="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">btn" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            &lt;path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        &lt;/svg></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">const</span> closBtn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseFromString</span><span class="token punctuation">(</span>svgStr<span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        closBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            removeTimer <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>removeTimer<span class="token punctuation">)</span>
            <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        messageDOM<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_prefixCls<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">message</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>closBtn<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 获取父节点容器
     * @return &#123;Element&#125; 节点DOM对象
     */</span>
    <span class="token function">_getContentBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> boxId <span class="token operator">=</span> <span class="token string">'messageBox'</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> boxId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> boxId<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> contentBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span>
            contentBox<span class="token punctuation">.</span>id <span class="token operator">=</span> boxId
            contentBox<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_default<span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token string">'px'</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>contentBox<span class="token punctuation">)</span>
            <span class="token keyword">return</span> contentBox
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * @description: 重新设置父节点高度
     */</span>
    <span class="token function">_setContentBoxTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> boxId <span class="token operator">=</span> <span class="token string">'messageBox'</span>
        <span class="token keyword">const</span> contentBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> boxId<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentBox<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            contentBox<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_default<span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token string">'px'</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/**
     * @description: 恢复默认值
     */</span>
    <span class="token function">_resetDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_default <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            top<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
            duration<span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module<span class="token punctuation">.</span>exports <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    window<span class="token punctuation">.</span>$message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f9c76b639ef46999ed7ac6553208dff~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h2 id="6-回顾"><a href="#6-回顾" class="headerlink" title="6. 回顾"></a>6. 回顾</h2><ul>
<li>定义</li>
<li>安装与使用（安装、调试、git拦截、测试报告）</li>
<li>常用API（jest、vue组件）</li>
<li>落地单元测试（拆分关键模块加单测）</li>
<li>演进：构建可测试单元模块（设计原则、重构）</li>
<li>可维护的单元模块（代码规范）</li>
</ul>
<p><strong>落地线路：</strong></p>
<p>① 安装使用 =&gt; ② API学习 =&gt; ③ 落地：拆分关键模块加单测 =&gt;  ④ 演进：架构设计与重构 =&gt;  ⑤ 代码规范 </p>
<p><strong>未来：</strong></p>
<p>⑥ 文档先行(待探索) </p>
<p>在较为复杂的业务系统开发过程中，从第一版代码到逐步划分模块、增加单测，还是走了一段弯路。<br>如果能够养成文档先行的习惯，先设计模块、测试用例，再编写代码，会更高效。</p>
<p><strong>理解：</strong></p>
<ul>
<li>单元测试有长期价值，也有执行成本。</li>
<li>好的架构设计是单测的土壤，<strong>为单一职责的模块设计单测、增加单元测试更加顺畅</strong>。</li>
<li>每个项目的业务形态与阶段不一样，不一定都适合，<strong>找到适合项目的平衡点</strong>。</li>
</ul>
<h2 id="7-讨论-amp-amp-Thank"><a href="#7-讨论-amp-amp-Thank" class="headerlink" title="7. 讨论 &amp;&amp; Thank"></a>7. 讨论 &amp;&amp; Thank</h2><p>感谢各位能够看到最后，前半部偏干，后半部分偏水，为内部分享笔记，部分代码和图片经过处理，重在分享和大家一起交流，恳请斧正，有收获还请点赞收藏。</p>

  <p> — 2021年7月8日</p>
  


          <div class="row mt-2">
  
    <div class="eight columns">
      <p id="madewith" style="color: #c7c7c7;">静水流深，闻喧享静。空山鸣响，见惯司空。
        
    </div>

    <!-- Sepcial thanks to https://simpleicons.org/ for the icons -->
    <div class="four columns mb-3 posisi" >
      
      <a class="ml-0 footer-link icon" href="https://github.com/nihaojob" target="_blank" style="text-decoration: none" rel="noreferrer" aria-label="GitHub">
        <svg class="github svg-hov" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      </a>
      

      

      

      

      

    </div>
  
</div>

        </div>
      </div>

    </div>

  </div>
  <script src="/js/nanobar.min.js"></script>
  <script>
    var options = {
      classname: 'nanobar',
      id: 'myNanobar'
    };
    var nanobar = new Nanobar(options);
    nanobar.go(30);
    nanobar.go(76);
    nanobar.go(100);
  </script>

</body>

</html>
